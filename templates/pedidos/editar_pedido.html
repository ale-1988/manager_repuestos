{% extends "base.html" %}
{% load tz %}
{% block contenido %}

<h2>Editar Pedido #{{ pedido.id }}</h2>
<hr>

<!-- ===================================================== -->
<!--     DATOS DEL CLIENTE — DISEÑO EN DOS COLUMNAS        -->
<!-- ===================================================== -->

{% if pedido.cliente %}
<h4>Cliente</h4>

<div class="card mb-4 shadow-sm">
    <div class="card-body">

        <h5 class="mb-3">{{ pedido.cliente.nombre }}</h5>

        <div class="row">
            <!-- ==================== COLUMNA IZQUIERDA ==================== -->
            <div class="col-md-6">
                <ul class="list-unstyled">

                    {% if pedido.cliente.cuit %}
                    <li><strong>CUIT:</strong> {{ pedido.cliente.cuit }}</li>
                    {% endif %}

                    {% if pedido.cliente.domicilio %}
                    <li><strong>Domicilio:</strong> {{ pedido.cliente.domicilio }}</li>
                    {% endif %}

                    {% if pedido.cliente.cod_postal %}
                    <li><strong>Código Postal:</strong> {{ pedido.cliente.cod_postal }}</li>
                    {% endif %}

                </ul>
            </div>

            <!-- ==================== COLUMNA DERECHA ==================== -->
            <div class="col-md-6">
                <ul class="list-unstyled">

                    {% if pedido.cliente.ciudad %}
                    <li><strong>Ciudad:</strong> {{ pedido.cliente.ciudad }}</li>
                    {% endif %}

                    {% if pedido.cliente.provincia %}
                    <li><strong>Provincia:</strong> {{ pedido.cliente.provincia }}</li>
                    {% endif %}

                    {% if pedido.cliente.pais %}
                    <li><strong>País:</strong> {{ pedido.cliente.pais }}</li>
                    {% endif %}

                    {% if pedido.cliente.telefono %}
                    <li><strong>Teléfono:</strong> {{ pedido.cliente.telefono }}</li>
                    {% endif %}

                    {% if pedido.cliente.email %}
                    <li><strong>Email:</strong> {{ pedido.cliente.email }}</li>
                    {% endif %}

                </ul>
            </div>
        </div>

    </div>
</div>
{% else %}
<p class="text-danger">Este pedido no tiene un cliente asignado.</p>
{% endif %}

<!-- ===================================================== -->
<!-- DATOS DEL PEDIDO                                      -->
<!-- ===================================================== -->

<h4>Datos del Pedido</h4>

<div class="card mb-4">
    <div class="card-body">

        <div class="row">

            <!-- ==================== COLUMNA IZQUIERDA ==================== -->
            <div class="col-md-6">
                {% if request.user.rol == "admin" or request.user.rol == "gerente" or request.user.rol == "operador" %}
                <form action="{% url 'pedidos:actualizar_estado' pedido.id %}" method="POST" class="mb-3">
                    {% csrf_token %}
                    <label><strong>Estado:</strong></label>
                    <select name="estado" class="form-select" style="max-width: 250px; display: inline-block;">
                        {% for valor, texto in pedido.ESTADOS %}
                            <option value="{{ valor }}" {% if pedido.estado == valor %}selected{% endif %}>
                                {{ texto }}
                            </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary btn-sm ms-2">Actualizar</button>
                </form>
                {% else %}
                <p><strong>Estado:</strong> {{ pedido.estado }}</p>
                {% endif %}
                <p><strong>Fecha:</strong> {{ pedido.fecha|localtime|date:"d/m/Y H:i" }}</p>
            </div>

            <!-- ==================== COLUMNA DERECHA ==================== -->
            <div class="col-md-6 text-md-end">

                {% if request.user.rol == "admin" or request.user.rol == "gerente" %}
                <form action="{% url 'pedidos:cancelar' pedido.id %}" method="POST">
                    {% csrf_token %}
                    <button class="btn btn-danger mt-2"
                            onclick="return confirm('¿Seguro desea cancelar este pedido?');">
                        Cancelar este pedido
                    </button>
                </form>
                {% endif %}

            </div>

        </div>

    </div>
</div>

<!-- ===================================================== -->
<!-- ITEMS DEL PEDIDO                                      -->
<!-- ===================================================== -->

<h4>Items del Pedido</h4>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>ID Repuesto</th>
            <th>Nombre</th>
            <th>Cantidad</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>{{ item.cod_repuesto }}</td>
            <td>{{ item.material.nombre }}</td>
            <td>{{ item.cantidad }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="3" class="text-center">No hay ítems.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{% url 'pedidos:listar' %}" class="btn btn-secondary mt-3">Volver al listado</a>

{% endblock %}
