<div class="modal-dialog modal-xl">
    <div class="modal-content">

        <!-- HEADER -->
        <div class="modal-header">
            <h5 class="modal-title">Buscar repuestos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- BODY -->
        <div class="modal-body">

            <!-- ========================================= -->
            <!--                TABS                      -->
            <!-- ========================================= -->
            <ul class="nav nav-tabs" id="modalTabs">
                <li class="nav-item">
                    <button class="nav-link {% if modo == 'id_ns' or not modo %}active{% endif %}"
                    data-bs-toggle="tab" data-bs-target="#tab_id_ns" data-tab="id_ns">
                    ID / Número de Serie</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if modo == 'materiales' %}active{% endif %}"
                    data-bs-toggle="tab" data-bs-target="#tab_materiales" data-tab="materiales">
                    Materiales</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if modo == 'equipos' %}active{% endif %}"
                    data-bs-toggle="tab" data-bs-target="#tab_equipos" data-tab="equipos">
                    Equipos</button>
                </li>
            </ul>

            <hr>

            <!-- ========================================= -->
            <!--          FORMULARIOS POR TAB              -->
            <!-- ========================================= -->
            <div id="tabContent">

                <!-- TAB 1 -->
                <form method="POST" data-tab-form="id_ns"
                      {% if modo != 'id_ns' and modo %}style="display:none;"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="modo" value="id_ns">

                    <label>Ingrese número:</label>
                    <input type="text" name="numero" class="form-control"
                           placeholder="ID (<30000) o NS (>30000)">

                    <button class="btn btn-primary w-100 mt-3">Buscar</button>
                </form>

                <!-- TAB 2 -->
                <form method="POST" data-tab-form="materiales"
                      {% if modo != 'materiales' %}style="display:none;"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="modo" value="materiales">

                    <label>Texto:</label>
                    <input type="text" name="texto_mat" class="form-control">

                    <label class="mt-2">
                        <input type="checkbox" name="mostrar_obsoletos">
                        Mostrar obsoletos
                    </label>

                    <button class="btn btn-primary w-100 mt-3">Buscar</button>
                </form>

                <!-- TAB 3 -->
                <form method="POST" data-tab-form="equipos"
                      {% if modo != 'equipos' %}style="display:none;"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="modo" value="equipos">

                    <label>Texto:</label>
                    <input type="text" name="texto_eq" class="form-control">

                    <button class="btn btn-primary w-100 mt-3">Buscar</button>
                </form>

            </div> <!-- /#tabContent -->

            <hr>

            <!-- ========================================= -->
            <!--         ÁREA FIJA DE RESULTADOS           -->
            <!-- ========================================= -->
            <div id="resultados">

                <!-- RESULTADOS DE MATERIAL (TAB 1 o TAB 2) -->
                {% if materiales is not None %}
                    <h4>Materiales encontrados</h4>

                    {% if materiales %}
                        <table class="table table-sm table-striped">
                            <tr>
                                <th>ID</th>
                                <th>Valor</th>
                                <th>Grupo</th>
                                <th>Acción</th>
                            </tr>

                            {% for m in materiales %}
                            <tr>
                                <td>{{ m.id_mate }}</td>
                                <td>{{ m.valor }}</td>
                                <td>{{ m.id_grup.GRUPO }}</td>
                                <td>
                                    <a class="btn btn-success btn-sm"
                                       href="/pedidos/agregar-item/{{ pedido_id }}/{{ m.id_mate }}/">
                                        Agregar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    {% else %}
                        <p>No se encontraron materiales.</p>
                    {% endif %}
                {% endif %}

                <!-- RESULTADOS DE EQUIPOS (TAB 3) -->
                {% if equipos %}
                    <h4>Equipos encontrados</h4>

                    <table class="table table-sm table-striped">
                        <tr>
                            <th>ID</th>
                            <th>Equipo</th>
                            <th>Acción</th>
                        </tr>

                        {% for eq in equipos %}
                        <tr>
                            <td>{{ eq.id_equi }}</td>
                            <td>{{ eq.equipo }}</td>
                            <td>
                                <form method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="modo" value="id_ns">
                                    <input type="hidden" name="numero" value="{{ eq.id_equi }}">
                                    <button class="btn btn-secondary btn-sm">
                                        Ver materiales
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endif %}

                <!-- LISTA DE MATERIALES DEL EQUIPO (BOM) -->
                {% if lista_equipo %}
                    <h4>Lista de materiales del equipo</h4>

                    <form method="POST" action="/pedidos/agregar-items-desde-modal/">
                        {% csrf_token %}
                        <input type="hidden" name="pedido_id" value="{{ pedido_id }}">
                        <input type="hidden" name="numero_serie" value="{{ numero_serie }}">

                        <table class="table table-bordered table-sm">
                            <tr><th>ID</th><th>Material</th><th>Cantidad</th></tr>

                            {% for grupo, mats in lista_equipo.items %}
                                <tr><td colspan="3"><strong>{{ grupo }}</strong></td></tr>

                                {% for mat in mats %}
                                <tr>
                                    <td>{{ mat.id_mate }}</td>
                                    <td>{{ mat.valor }}</td>
                                    <td>
                                        <input type="number" name="cantidad_{{ mat.id_mate }}"
                                               class="form-control form-control-sm"
                                               value="{{ mat.cantidad }}">
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </table>

                        <button class="btn btn-success w-100">Agregar todos</button>
                    </form>
                {% endif %}

            </div>

        </div> <!-- /modal-body -->
    </div>
</div>

<script>
document.querySelectorAll("#modalTabs button").forEach(btn => {
    btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;

        // activar tab visual
        document.querySelectorAll("#modalTabs button").forEach(x => x.classList.remove("active"));
        btn.classList.add("active");

        // mostrar form del tab
        document.querySelectorAll("[data-tab-form]").forEach(f => f.style.display = "none");
        document.querySelector(`[data-tab-form="${tab}"]`).style.display = "block";
    });
});
</script>
